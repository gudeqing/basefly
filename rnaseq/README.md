# RNA-seq 分析流程

本流程为标准RNAseq分析流程，包括原始数据预处理、比对、融合基因检测、HLA定型等分析步骤。流程所需软件均已经打包至一个docker镜像。
在XDP上，通过docker-runner应用可以直接启动该镜像，通过一条命令行进行批量运行分析。该流程支持自动断点需跑，运行状态可视化。

## Table of Contents

- [Summary](#Summary)
- [Install](#install)
- [Tools](#tools)
- [Usage](#usage)
- [To do list](#todolist)
- [Maintainers](#maintainers)
- [License](#license)

## Summary

The workflow has the following main steps:
* Raw data processing using fastp
* Alignment to reference genome sequencing using STAR or sentieon STAR
* Quality control analysis using "Picard CollectRnaSeqMetrics"
* Gene/Transcript expression quantification using "Salmon" with alignment bam as input.
* Gene fusion analysis using STAR-Fusion
* HLA typing with the arcasHLA software

## Install

This workflow is developed to be run on XDP without any installation. But it is also can be run locally with needed tools installed.

## Tools
* fastp:0.23.0
* (sentieon) STAR:2.7.8a
* STAR-Fusion:1.10.0
* picard: 2.20.3-SNAPSHOT
* salmon: 1.5.2
* arcasHLA:0.2.5

## Usage

### using docker runner mode
1. Log in XDP using Google Chrome browser.
2. Go to your project workspace and launch a docker instance with 'rnaseq_envs:1.2' image. remember to set enough attach_storage.
For computing resource, we encourage you to use spot instance to save money since our workflow support continuing run mode,
and you can always get back to your workspace as long as you keep the attach storage un-detached.
3. Then, change to "/root/attach_storage" directory. Run the following command:
```
python */rnaseq.py ....
```
4. Try to run the workflow again with above same command after you have solved the potential problems. It is will init the workflow at failed steps automatically.

### using APP mode
developing ......


### All input files of the workflow
* rnaseq_pipeline.getFastqInfo.fastq_files: fastq file list

* rnaseq_pipeline.getFastqInfo.r1_name: python regExp that describes the full name of read1 fastq file name. It requires at least one pair of small brackets, and the string matched in the first pair brackets will be used as sample name. Example: '(.\*).R1.fq.gz'

* rnaseq_pipeline.getFastqInfo.r2_name: python regExp that describes the full name of read1 fastq file name. It requires at least one pair of small brackets, and the string matched in the first pair brackets will be used as sample name. Example: '(.\*).R2.fq.gz'

* rnaseq_pipeline.align.indexFiles: STAR index files

* rnaseq_pipeline.rsem_quant.indexFiles: RSEM index files

* rnaseq_pipeline.fusion.indexFiles: CTAT_resource_lib from https://data.broadinstitute.org/Trinity/CTAT_RESOURCE_LIB/__genome_libs_StarFv1.10/GRCh37_gencode_v19_CTAT_lib_Mar012021.plug-n-play.tar.gz

* rnaseq_pipeline.CollectRnaSeqMetrics.ref_flat: genome annotation file, download site: http://hgdownload.cse.ucsc.edu/goldenPath/hg19/database/refFlat.txt.gz

* rnaseq_pipeline.CollectRnaSeqMetrics.ribosomal_intervals: rRNA interval file generated by using picard BedToIntervalList command

* rnaseq_pipeline.read_distribution.refGene: gene model file for RSeQC, can be downloaded at http://rseqc.sourceforge.net/

* rnaseq_pipeline.rnaseqc.collapsed_gtf: collapsed gtf file for rnaseqc, please refer to https://github.com/getzlab/rnaseqc/

* rnaseq_pipeline.CIRCexplorer2.genome: reference genome fasta file

* rnaseq_pipeline.CIRCexplorer2.genome_annot: genome annotation file in [GenePred table format](https://genome.ucsc.edu/FAQ/FAQformat.html#format9). This file can also be downloaded by using command of CIRCexplorer2 such as "*fetch_ucsc.py hg19 ens hg19_ens.txt*"

### Create STAR index
Example cmd:
```angular2html
STAR --runThreadN 5 \
    --runMode genomeGenerate \
    --genomeDir star_index \
    --genomeFastaFiles chr22_with_ERCC92.fa \
    --sjdbGTFfile chr22_with_ERCC92_tidy.gtf \
    --sjdbOverhang 99 # read length -1
```

### Create RSEM index
Example cmd:
```angular2html
mkdir -p rsem_index
rsem-prepare-reference \
    --gtf chr22_with_ERCC92_tidy.gtf \
    -p 5 \
    chr22_with_ERCC92.fa \
    rsem_index/rsem
```

## To do list
- Merge expression result when multiple samples are available
- DESeq2
- Deconvolution of Immune Cell Proportions
- TCR analysis

## Maintainers

Email: *danny.gu@basebit.ai*

## License

[MIT © Richard McRichface.](../LICENSE)